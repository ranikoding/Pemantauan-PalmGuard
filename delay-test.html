// Fungsi untuk mengukur delay - VERSI DIPERBAIKI
async function measureDelay() {
    const channelId = document.getElementById('channel-id').value;
    const apiKey = document.getElementById('api-key').value;
    
    try {
        // Catat waktu website SEBELUM request (WITA)
        const waktuWebsiteSebelum = new Date();
        
        // Lakukan request ke ThingSpeak
        const response = await fetch(`https://api.thingspeak.com/channels/${channelId}/feeds/last.json?api_key=${apiKey}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Catat waktu website SETELAH request (WITA)
        const waktuWebsiteSesudah = new Date();
        
        // Waktu dari ThingSpeak (convert ke WITA)
        const waktuThingSpeakUTC = new Date(data.created_at);
        const waktuThingSpeakWITA = convertUTCtoWITA(waktuThingSpeakUTC);
        
        // Hitung delay yang benar: 
        // (Waktu website SETELAH request - Waktu website SEBELUM request) / 2
        // PLUS selisih antara waktu ThingSpeak dan waktu rata-rata website
        const waktuWebsiteRataRata = new Date((waktuWebsiteSebelum.getTime() + waktuWebsiteSesudah.getTime()) / 2);
        const delay = (waktuWebsiteRataRata.getTime() - waktuThingSpeakUTC.getTime()) / 1000;
        
        // Simpan hasil pengujian
        testCount++;
        const testResult = {
            id: testCount,
            waktuThingSpeak: waktuThingSpeakWITA,
            waktuWebsite: waktuWebsiteRataRata,
            delay: Math.abs(delay), // Gunakan absolute value
            field5: data.field5 || 'N/A'
        };
        
        testResults.push(testResult);
        
        // Update tampilan
        updateDelayIndicator(delay);
        addTestResultToTable(testResult);
        updateStatistics();
        updateChart();
        
        console.log(`Pengujian #${testCount}: Delay = ${delay.toFixed(2)} detik`);
        
        return delay;
    } catch (error) {
        console.error("Gagal mengukur delay:", error);
        updateDelayIndicator(null, error.message);
        return null;
    }
}

// Fungsi untuk konversi UTC ke WITA yang lebih akurat
function convertUTCtoWITA(utcDate) {
    // Buat date object baru dengan waktu yang sama
    const witaDate = new Date(utcDate);
    // Tambahkan 8 jam untuk WITA (UTC+8)
    witaDate.setHours(witaDate.getHours() + 8);
    return witaDate;
}

// Fungsi untuk memformat waktu WITA
function formatWaktuWITA(date) {
    return date.toLocaleTimeString('id-ID', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        timeZone: 'Asia/Makassar'
    }) + '.' + date.getMilliseconds().toString().padStart(3, '0');
}
